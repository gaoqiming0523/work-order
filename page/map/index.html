<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="./index.css" />
    <link rel="stylesheet" type="text/css" href="../../index.css" />
    <link rel="stylesheet" type="text/css" href="../../page/rest.css" />
    <link rel="stylesheet" href=" ../../css/sm.min.css" />
  </head>

  <body>
    <!-- page 容器 -->
    <div class="page" id="app">
      <!-- 标题栏 -->
      <header class="bar bar-nav theme-dark">
        <div class="bar bar-header-secondary">
          <div class="searchbar">
            <a class="searchbar-cancel">取消</a>
            <div class="search-input">
              <label class="icon icon-search" for="search"></label>
              <input type="search" id="search" placeholder="输入工单..." />
            </div>
          </div>
        </div>
      </header>

      <!-- 工具栏 -->
      <nav class="bar bar-tab">
        <a class="tab-item external" href="../../index.html">
          <span class="icon icon-menu"></span>
          <span class="tab-label">工单</span>
        </a>
        <a class="tab-item external active" href="../map/index.html">
          <span class="icon icon-star"></span>
          <span class="tab-label">地图</span>
        </a>
        <a class="tab-item external" href="../message/index.html">
          <span class="icon icon-message"></span>
          <span class="tab-label">消息</span>
          <span class="badge">{{notReadNum}}</span>
        </a>
        <a class="tab-item external" href="../mine/index.html">
          <span class="icon icon-me"></span>
          <span class="tab-label">我的</span>
        </a>
      </nav>

      <!-- 这里是页面内容区 -->
      <div class="content">
        <!-- 头像及工号 -->
        <div id="allmap"></div>

        <div class="work-order" v-if="selectItem" @click="fnClickJumpToDetail(selectItem.id)">
          <span class="work-order-icon" :style="selectItem.state === 3 ? 'background: #4589FB' : '' "
            >{{ selectItem.state === 1 ? '单' : selectItem.state === 2 ? '多' : '中' }}</span
          >
          <div class="work-order-content">
            <p class="work-order-title">
              <span class="work-order-number">NO.</span>
              {{ selectItem.id }}
            </p>
            <p class="work-order-time">{{ selectItem.createTime }}</p>
            <p class="work-order-desc">{{ selectItem.faultName }}</p>
            <p class="work-order-map">{{ selectItem.address }}</p>
          </div>

          <div class="work-order-button">接单</div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=iRga2Xe4ZYZH6lCxGYTw6ruEH20FL2GE"></script>
  <script src="../../js/jquery/jquery-3.3.1.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="../ajax.js" type="text/javascript" charset="utf-8"></script>
  <script src=" ../../js/sm.min.js" type="text/javascript"></script>
  <script src=" ../../js/sm-extend.min.js" type="text/javascript"></script>
  <script src=" ../../js/sm-city-picker.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    var app = new Vue({
      el: '#app',
      data() {
        return {
          notReadNum: '',
          selectItem: null
        };
      },
      methods: {
        fnClickJumpToDetail(id) {
          location.href = '../details/index.html?id=' + id;
        },
        fnGetNotReadMessage() {
          var token = localStorage.getItem('sToken');
          axios({
            method: 'get',
            url: 'http://121.42.233.49:7888/msg/not-read',
            headers: { token: token },
          })
            .then((response) => {
              this.notReadNum = response.data.data;
            })
            .catch(function (error) {
              location.href = '../login/index.html';
            });
        },
        getPoint() {
          var token = localStorage.getItem('sToken');
          axios({
            method: 'post',
            url: 'http://121.42.233.49:7888/job/map',
            headers: { token: token },
            params: {
              stateQ: 1,
            },
          })
            .then((response) => {
              this.aList = response.data.data;
              this.getMap();
            })
            .catch(function (error) {
              // location.href = '../login/index.html'
            });
        },
        getMap() {
          var that = this
          var map = new BMap.Map('allmap');
          var point = new BMap.Point(116.404, 39.915);
          map.centerAndZoom(point, 12);
          // 添加带有定位的导航控件
          var navigationControl = new BMap.NavigationControl({
            // 靠左上角位置
            anchor: BMAP_ANCHOR_TOP_LEFT,
            // LARGE类型
            type: BMAP_NAVIGATION_CONTROL_LARGE,
            // 启用显示定位
            enableGeolocation: true,
          });
          map.addControl(navigationControl);
          function addClickHandler(label, data) {
            label.addEventListener('click', function (e) {
              that.selectItem = data
            });
          }
          // 编写自定义函数,创建标注
          function addMarker(point,data) {
            var marker = new BMap.Marker(point);
            map.addOverlay(marker);
            var label = new BMap.Label(`工单编号：${data.id}`);
            addClickHandler(label,data);
            marker.setLabel(label);
          }


          // 随机向地图添加25个标注
          var bounds = map.getBounds();
          var sw = bounds.getSouthWest();
          var ne = bounds.getNorthEast();
          var lngSpan = Math.abs(sw.lng - ne.lng) || 0.3;
          var latSpan = Math.abs(ne.lat - sw.lat) || 0.3;
          for (var i = 0; i < this.aList.length; i++) {
            var point = new BMap.Point(this.aList[i].lng, this.aList[i].lat);
            addMarker(point, this.aList[i]);
          }
        },
      },
      created() {
        this.getPoint();
        this.fnGetNotReadMessage();
      },
    });
  </script>
</html>
